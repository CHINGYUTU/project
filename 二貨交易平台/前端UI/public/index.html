<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>二手交易平台</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="images/logo.png" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/chat.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 保持原有的樣式不變 */
        .product-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }
        .product-card {
            width: 280px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            background: white;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .product-card h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #333;
            height: 40px;
            overflow: hidden;
        }
        .product-card .description {
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 10px;
            height: 40px;
            overflow: hidden;
        }
        .product-card .price {
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1rem;
        }
        .product-card .seller {
            font-size: 0.85rem;
            color: #666;
        }
        .product-card .location {
            font-size: 0.85rem;
            color: #666;
        }
        .product-card .date {
            font-size: 0.8rem;
            color: #888;
        }
        .product-card .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .product-card .btn-buy {
            width: 100%;
            margin-top: 10px;
        }
        /* 可左右滑動分類按鈕列 */
        .category-scroll {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            scroll-snap-type: x mandatory;
            padding: 10px 0;
        }
        .category-scroll a {
            flex-shrink: 0;
            scroll-snap-align: start;
            margin-right: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f0f0f0;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
        }
        .category-scroll a:hover, .category-scroll a.active {
            background: #3085d6;
            color: white;
        }
        /* 自訂 scrollbar 樣式 */
        .category-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .category-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .transparent-search {
            background: rgba(255,255,255,0.8);
            border-radius: 50px;
            padding: 5px 15px;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 30px;
        }
        .loading-spinner i {
            font-size: 2rem;
            color: #3085d6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 收藏按鈕樣式 */
        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }
        .favorite-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        .favorite-btn i {
            font-size: 18px;
            color: #ccc; /* 預設灰色空心 */
        }
        .favorite-btn.favorited i {
            color: #dc3545; /* 收藏後紅色實心 */
        }
    </style>
</head>
<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg bg-mytheme text-uppercase fixed-top" id="mainNav">
        <div class="container">
            <a href="index.html" class="navbar-brand d-flex align-items-center">
                <img src="images/logo.png" alt="Logo" style="height: 60px;">
            </a>
            <a class="navbar-brand" href="index.html">二貨</a>
            <button class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown" id="menuWrapper" onmouseenter="showMenu()" onmouseleave="hideMenu()">
                        <a class="nav-link dropdown-toggle py-3 px-0 px-lg-3 rounded" href="#" role="button">
                            Menu
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" id="menuList">
                            <!-- JS 動態填入 -->
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Masthead-->
    <header class="masthead bg-mycolor text-white text-center">
        <div class="container d-flex align-items-center flex-column">
            <!-- Masthead Heading-->
            <h1 style="color: #000;" class="masthead-heading text-uppercase mb-0">二貨交易</h1>
            <!-- Icon Divider-->
            <div class="divider-custom divider-light">  
                <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                <div class="divider-custom-line"></div>
                <!-- Masthead Subheading-->
                <p style="color: #000;" class="masthead-subheading font-weight-light mb-0">校園二手貨-你用不到我幫你用</p>
                <div class="divider-custom-line"></div><div class="divider-custom-icon"><i class="fas fa-star"></i></div>
            </div>
        </div>
        <div>
            <!-- 結構部分 -->
            <div class="container d-flex align-items-center justify-content-between flex-wrap">

                <!-- 中：搜尋欄 -->
                <div class="flex-grow-1 mx-3 transparent-search">
                    <input type="text" class="form-control border-0 bg-transparent" placeholder="搜尋品牌、型號、關鍵字……" id="searchInput">
                </div>
                <!-- 下方分類按鈕 - 已按您的要求調整分類 -->
                <div class="w-100 mt-2">
                    <div class="category-scroll">
                        <a href="#" class="active" data-category="all">所有商品</a>
                        <a href="#" data-category="1">電子產品</a>
                        <a href="#" data-category="2">生活用品</a>
                        <a href="#" data-category="3">書籍</a>
                        <a href="#" data-category="4">運動用品</a>
                        <a href="#" data-category="5">服飾</a>
                        <a href="#" data-category="6">周邊</a>
                    </div>
                </div>
                <!-- 篩選列 -->
                <div class="d-flex flex-wrap align-items-center mt-2 gap-3 w-100">
                    <div class="d-flex align-items-center">
                        <span class="me-2" style="color: #000;">篩選</span>
                        <select class="form-select form-select-sm" id="priceFilter" style="width: 150px;">
                            <option value="">價格範圍</option>
                            <option value="0-500">0 - 500元</option>
                            <option value="500-1000">500 - 1,000元</option>
                            <option value="1000-2000">1,000 - 2,000元</option>
                            <option value="2000-5000">2,000 - 5,000元</option>
                            <option value="5000-">5,000元以上</option>
                        </select>
                    </div>
                    <select class="form-select form-select-sm" id="timeFilter" style="width: 150px;">
                        <option value="">上架時間</option>
                        <option value="1">最近 1 天</option>
                        <option value="7">最近 7 天</option>
                        <option value="30">最近 30 天</option>
                    </select>
                    <select class="form-select form-select-sm" id="sortFilter" style="width: 150px;">
                        <option value="newest">最新上架</option>
                        <option value="price_asc">價格: 低到高</option>
                        <option value="price_desc">價格: 高到低</option>
                    </select>
                </div>
            </div>
        </div>
    </header> 
    <!-- Portfolio Section-->
    <section class="page-section portfolio" id="portfolio">
        <div class="container">
            <!-- Portfolio Section Heading-->
            <h2 class="page-section-heading text-center text-uppercase text-secondary mb-0">商品列表</h2>
            <!-- Icon Divider-->
            <div class="divider-custom">
                <div class="divider-custom-line"></div>
                <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                <div class="divider-custom-line"></div>
            </div>
            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <i class="fas fa-spinner"></i>
                <p>載入商品中...</p>
            </div>
            <!-- Product Container -->
            <div class="product-container" id="productContainer"></div>
            <!-- No Products Message -->
            <div class="text-center py-5" id="noProducts" style="display: none;">
                <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
                <h4 class="text-muted">目前沒有符合條件的商品</h4>
                <p class="text-muted">請嘗試調整篩選條件或稍後再試</p>
            </div>
        </div>
    </section>

    <!-- Footer-->
    <footer class="footer text-center">
        <div class="container">
            <div class="row">
                <!-- Footer Location-->
                <div class="col-lg-4 mb-5 mb-lg-0">
                    <h4 class="text-uppercase mb-4">Location</h4>
                    <p class="lead mb-0">
                        NTUB
                        <br />
                        1234
                    </p>
                </div>
                <!-- Footer Social Icons-->
                <div class="col-lg-4 mb-5 mb-lg-0">
                    <h4 class="text-uppercase mb-4">聯絡我們</h4>
                    <a class="btn btn-outline-light btn-social mx-1" href="#!"><i class="fab fa-fw fa-facebook-f"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="#!"><i class="fab fa-fw fa-twitter"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="#!"><i class="fab fa-fw fa-linkedin-in"></i></a>
                    <a class="btn btn-outline-light btn-social mx-1" href="#!"><i class="fab fa-fw fa-dribbble"></i></a>
                </div>
            </div>
        </div>
    </footer>
    <!-- Copyright Section-->
    <div class="copyright py-4 text-center text-white">
        <div class="container"><small>Copyright &copy; Your Website 2023</small></div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JWT Decode -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script>
        // 全域變數儲存商品資料
        let allProducts = [];
        let currentDisplayedProducts = [];
        let userFavorites = new Set(); // 儲存使用者收藏的商品ID

        // 分類名稱映射
        const categoryNames = {
            1: '電子產品',
            2: '生活用品',
            3: '書籍',
            4: '運動用品',
            5: '服飾',
            6: '周邊'
        };

        // API基礎URL
        const API_BASE = 'http://localhost:3000';

        // 頁面載入時執行
        window.addEventListener('DOMContentLoaded', () => {
            showMenu();
            fetchProducts();
            setupEventListeners();
        });

        // ======================= 收藏功能相關API =======================

        /**
         * 獲取使用者收藏列表
         */
        async function fetchUserFavorites() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('使用者未登入，無法獲取收藏列表');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/favorite/my-favorites`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // 將收藏的商品ID存入Set中以便快速查找
                    if (result.data && Array.isArray(result.data)) {
                        userFavorites = new Set(result.data.map(fav => fav.item_id));
                        console.log('使用者收藏列表:', userFavorites);
                    }
                } else {
                    console.error('獲取收藏列表失敗:', response.status);
                }
            } catch (error) {
                console.error('獲取收藏列表失敗:', error);
            }
        }

        /**
         * 添加收藏
         * @param {number} itemId - 商品ID
         */
        async function addToFavorites(itemId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    Swal.fire('請先登入', '需要登入才能收藏商品', 'warning');
                    return false;
                }
                
                const response = await fetch(`${API_BASE}/api/favorite/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ item_id: itemId })
                });
                
                if (response.ok) {
                    userFavorites.add(itemId); // 新增到本地收藏集合
                    return true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '收藏失敗');
                }
            } catch (error) {
                console.error('新增收藏失敗:', error);
                Swal.fire('錯誤', error.message, 'error');
                return false;
            }
        }

        /**
         * 取消收藏
         * @param {number} itemId - 商品ID
         */
        async function removeFromFavorites(itemId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return false;
                
                const response = await fetch(`${API_BASE}/api/favorite/remove/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    userFavorites.delete(itemId); // 從本地收藏集合移除
                    return true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '取消收藏失敗');
                }
            } catch (error) {
                console.error('取消收藏失敗:', error);
                Swal.fire('錯誤', error.message, 'error');
                return false;
            }
        }

        /**
         * 切換收藏狀態
         * @param {number} itemId - 商品ID
         * @param {HTMLElement} button - 收藏按鈕元素
         */
        async function toggleFavorite(itemId, button) {
            const isCurrentlyFavorited = userFavorites.has(itemId);
            
            let success = false;
            if (isCurrentlyFavorited) {
                success = await removeFromFavorites(itemId);
            } else {
                success = await addToFavorites(itemId);
            }
            
            if (success) {
                // 更新按鈕樣式
                button.classList.toggle('favorited');
                button.querySelector('i').className = isCurrentlyFavorited ? 
                    'bi bi-heart' : 'bi bi-heart-fill';
            }
        }

        // ======================= 商品功能相關 =======================

        // 設定事件監聽器
        function setupEventListeners() {
            // 分類按鈕點擊事件
            document.querySelectorAll('.category-scroll a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 移除所有active類
                    document.querySelectorAll('.category-scroll a').forEach(item => {
                        item.classList.remove('active');
                    });
                    // 新增active類到當前點擊的按鈕
                    this.classList.add('active');
                    // 過濾商品
                    filterProducts();
                });
            });

            // 價格篩選事件
            document.getElementById('priceFilter').addEventListener('change', filterProducts);

            // 時間篩選事件
            document.getElementById('timeFilter').addEventListener('change', filterProducts);

            // 排序篩選事件
            document.getElementById('sortFilter').addEventListener('change', filterProducts);

            // 搜尋輸入事件
            document.getElementById('searchInput').addEventListener('input', debounce(filterProducts, 300));
        }

        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // 從API獲取商品資料
        async function fetchProducts() {
            try {
                showLoading(true);
                
                // 先獲取使用者收藏列表
                await fetchUserFavorites();
                
                const response = await fetch(`${API_BASE}/api/item/available`);
                
                if (!response.ok) {
                    throw new Error(`HTTP錯誤! 狀態碼: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API 返回資料:', result);
                
                // 從 result.data 獲取商品陣列
                if (!result.data || !Array.isArray(result.data)) {
                    throw new Error('API 返回的資料格式不正確，缺少 data 陣列');
                }
                
                allProducts = result.data;
                currentDisplayedProducts = [...result.data];
                renderProducts(result.data);
                showLoading(false);
            } catch (error) {
                console.error('獲取商品失敗:', error);
                showLoading(false);
                document.getElementById('productContainer').innerHTML = `
                    <div class="col-12 text-center my-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-danger">無法載入商品，請稍後再試</p>
                        <p class="text-muted small">${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="fetchProducts()">重新載入</button>
                    </div>
                `;
            }
        }

        // 顯示/隱藏載入動畫
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // 過濾商品函數
        function filterProducts() {
            let filtered = [...allProducts];
            
            // 獲取當前選中的分類
            const activeCategory = document.querySelector('.category-scroll a.active')?.dataset.category;
            
            // 分類篩選 (根據 category_id)
            if (activeCategory && activeCategory !== 'all') {
                filtered = filtered.filter(item => item.category_id == activeCategory);
            }
            
            // 價格篩選
            const priceFilter = document.getElementById('priceFilter').value;
            if (priceFilter) {
                const [min, max] = priceFilter.split('-').map(part => part === '' ? null : Number(part));
                if (min !== null && max !== null) {
                    filtered = filtered.filter(item => {
                        const price = parseFloat(item.price);
                        return price >= min && price <= max;
                    });
                } else if (min !== null && max === null) {
                    filtered = filtered.filter(item => parseFloat(item.price) >= min);
                } else if (min === null && max !== null) {
                    filtered = filtered.filter(item => parseFloat(item.price) <= max);
                }
            }
            
            // 時間篩選
            const timeFilter = document.getElementById('timeFilter').value;
            if (timeFilter) {
                const days = parseInt(timeFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.created_at);
                    return itemDate >= cutoffDate;
                });
            }
            
            // 搜尋篩選
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    (item.description && item.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // 排序
            const sortFilter = document.getElementById('sortFilter').value;
            switch(sortFilter) {
                case 'price_asc':
                    filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                    break;
                case 'price_desc':
                    filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                    break;
                case 'newest':
                default:
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }
            
            currentDisplayedProducts = filtered;
            renderProducts(filtered);
        }

        // 渲染商品到頁面
        function renderProducts(products) {
            const container = document.getElementById('productContainer');
            const noProductsMsg = document.getElementById('noProducts');
            
            container.innerHTML = '';
            
            if (!products || !Array.isArray(products) || products.length === 0) {
                noProductsMsg.style.display = 'block';
                return;
            }
            
            noProductsMsg.style.display = 'none';
            
            // Base64 編碼的透明佔位圖
            const defaultProductImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            
            products.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'product-card position-relative';
                
                // 格式化日期
                const createdAt = new Date(item.created_at);
                const formattedDate = `${createdAt.getFullYear()}/${(createdAt.getMonth()+1).toString().padStart(2, '0')}/${createdAt.getDate().toString().padStart(2, '0')}`;
                
                // 狀態標籤
                let statusBadge = '';
                if (item.status === 'available') {
                    statusBadge = '<span class="status-badge bg-success">可購買</span>';
                } else if (item.status === 'reserved') {
                    statusBadge = '<span class="status-badge bg-warning text-dark">預訂中</span>';
                } else {
                    statusBadge = '<span class="status-badge bg-secondary">已售出</span>';
                }
                
                // 處理圖片路徑
                let imageUrl = defaultProductImage;
                if (item.image_url) {
                    if (item.image_url.startsWith('http')) {
                        imageUrl = item.image_url;
                    } else if (item.image_url.startsWith('/')) {
                        imageUrl = `${API_BASE}/uploads${item.image_url}`;
                    } else {
                        imageUrl = `${API_BASE}/${item.image_url}`;
                    }
                }
                
                // 檢查是否已收藏
                const isFavorited = userFavorites.has(item.id);
                
                card.innerHTML = `
                    ${statusBadge}
                    <!-- 收藏按鈕 -->
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" 
                            onclick="toggleFavorite(${item.id}, this)">
                        <i class="bi ${isFavorited ? 'bi-heart-fill' : 'bi-heart'}"></i>
                    </button>
                    
                    <img src="${imageUrl}" alt="${item.name}" 
                        onerror="this.src='${defaultProductImage}'">
                    <h3>${item.name}</h3>
                    <p class="text-muted small">${categoryNames[item.category_id] || `分類${item.category_id}`}</p>
                    <p class="description">${item.description || '暫無描述'}</p>
                    <p class="price">$${item.price}</p>
                    <p class="seller"><i class="bi bi-person"></i> 賣家ID: ${item.user_id}</p>
                    <p class="location"><i class="bi bi-geo-alt"></i> ${item.location}</p>
                    <p class="date"><i class="bi bi-clock"></i> ${formattedDate}</p>
                    <button class="btn btn-primary btn-buy" 
                            onclick="showPurchasePopup(${item.id}, '${escapeHtml(item.name)}', ${item.price}, 
                            '${escapeHtml(imageUrl)}', '${escapeHtml(item.location)}', ${item.user_id})">
                        <i class="bi bi-cart-plus"></i> 購買
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // HTML 跳脫函數
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // 顯示購買彈窗
        function showPurchasePopup(itemId, itemName, price, imageUrl, location, sellerId) {
            Swal.fire({
                title: `確認購買「${itemName}」？`,
                html: `
                    <div class="text-start">
                        <p><strong>價格：</strong>$${price}</p>
                        <p><strong>賣家ID：</strong>${sellerId}</p>
                        <p><strong>交易地點：</strong>${location}</p>
                        <img src="${imageUrl}" alt="${itemName}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '✅ 確認購買',
                cancelButtonText: '取消',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                showLoaderOnConfirm: true,
                preConfirm: async () => {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            throw new Error("請先登入再購買");
                        }

                        // 1️⃣ 先建立訂單
                        const createRes = await fetch(`${API_BASE}/api/purchase`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ itemId })
                        });

                        if (!createRes.ok) {
                            const err = await createRes.json();
                            throw new Error(err.message || "建立訂單失敗");
                        }

                        const orderData = await createRes.json();
                        const orderId = orderData.data?.id; // 假設後端回傳 { data: { id: xxx } }
                        if (!orderId) throw new Error("後端未回傳訂單 ID");

                        // 2️⃣ 更新訂單狀態為 confirmed
                        const updateRes = await fetch(`${API_BASE}/api/order/update-status/${orderId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ orderStatus: "confirmed" })
                        });

                        if (!updateRes.ok) {
                            const err = await updateRes.json();
                            throw new Error(err.message || "更新訂單狀態失敗");
                        }

                        return await updateRes.json();

                    } catch (error) {
                        Swal.showValidationMessage(
                            `購買失敗: ${error.message}`
                        );
                        return false;
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: '✅ 購買成功！',
                        text: `「${itemName}」已成功購買，狀態已更新為 Confirmed。`,
                        icon: 'success',
                        confirmButtonText: '知道了',
                        confirmButtonColor: '#6474E1'
                    });
                    // 刷新商品列表
                    fetchProducts();
                }
            });
        }

        // 登入選單功能
        function showMenu() {
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';

            const token = localStorage.getItem('token');
            if (!token) {
                // 未登入，顯示訪客選單
                menuList.innerHTML = `
                    <li><a class="dropdown-item" href="/login.html"><i class="fas fa-sign-in-alt me-2"></i>登入/註冊</a></li>
                `;
            } else {
                try {
                    const decoded = jwt_decode(token);
                    const role = decoded.role;

                    if (role === 'user') {
                        // 一般使用者
                        menuList.innerHTML = `
                            <li><a class="dropdown-item" href="dist/elements/profile.html"><i class="fas fa-user me-2"></i>個人檔案</a></li>
                            <li><a class="dropdown-item" href="dist/elements/point.html"><i class="fas fa-coins me-2"></i>點數兌換</a></li>
                            <li><a class="dropdown-item" href="dist/elements/myitems.html"><i class="fas fa-box-open me-2"></i>我的商品</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
                        `;
                    } else if (role === 'admin') {
                        // 管理員
                        menuList.innerHTML = `
                            <li><a class="dropdown-item" href="/audcom.html"><i class="fas fa-cog me-2"></i>管理員後台</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>登出</a></li>
                        `;
                    } else {
                        // 其他預設當訪客
                        menuList.innerHTML = `
                            <li><a class="dropdown-item" href="../public/login.html"><i class="fas fa-sign-in-alt me-2"></i>登入/註冊</a></li>
                        `;
                    }
                } catch (e) {
                    console.error('JWT 解碼失敗:', e);
                    menuList.innerHTML = `
                        <li><a class="dropdown-item" href="../public/login.html"><i class="fas fa-sign-in-alt me-2"></i>登入/註冊</a></li>
                    `;
                }
            }
            menuList.classList.add('show');
        }

        function hideMenu() {
            document.getElementById('menuList').classList.remove('show');
        }

        // 登出功能
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }
    </script>
</body>
</html>