<!DOCTYPE html>
<html lang="en">
<head>
<title>密碼重設</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- 樣式連結 -->
<link rel="stylesheet" type="text/css" href="/vendor/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/fonts/iconic/css/material-design-iconic-font.min.css">
<link rel="stylesheet" type="text/css" href="/vendor/animate/animate.css">
<link rel="stylesheet" type="text/css" href="/vendor/css-hamburgers/hamburgers.min.css">
<link rel="stylesheet" type="text/css" href="/vendor/animsition/css/animsition.min.css">
<link rel="stylesheet" type="text/css" href="/vendor/select2/select2.min.css">
<link rel="stylesheet" type="text/css" href="/vendor/daterangepicker/daterangepicker.css">
<link rel="stylesheet" type="text/css" href="/css/util.css">
<link rel="stylesheet" type="text/css" href="/css/main.css">

<style>
.password-checklist li {
    font-size: 15px;
    margin-bottom: 4px;
}
.progress {
    height: 8px;
    margin-top: 8px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}
.progress-bar {
    transition: width 0.5s ease, background-color 0.4s ease;
    border-radius: 10px;
}
#strengthText {
    transition: color 0.4s ease;
}
</style>
</head>

<body>
<div class="limiter">
<div class="container-login100">
    <div class="wrap-login100">
    <form class="login100-form validate-form" id="resetPasswordForm" onsubmit="return handleRegister(event)">
        <span class="login100-form-title p-b-26">密碼重設</span>
        <span class="login100-form-title p-b-48">
        <img src="/images/logo.png" alt="Logo" style="height: 60px;">
        </span>
        <!-- Password -->
        <div class="wrap-input100 validate-input" data-validate="輸入新密碼">
        <span class="btn-show-pass"><i class="zmdi zmdi-eye"></i></span>
        <input class="input100" type="password" name="pass" required>
        <span class="focus-input100" data-placeholder="輸入新密碼"></span>
        </div>
        
        <!-- 確認新密碼 -->
        <div class="wrap-input100 validate-input" data-validate="再次輸入密碼">
        <span class="btn-show-pass"><i class="zmdi zmdi-eye"></i></span>
        <input class="input100" type="password" name="confirmPass" required>
        <span class="focus-input100" data-placeholder="確認新密碼"></span>
        </div>

        <!-- 密碼強度條 -->
        <div class="mt-2">
        <div class="progress">
            <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <small id="strengthText" class="text-muted">密碼強度：尚未輸入</small>
        </div>


        <!-- 密碼條件 -->
        <div class="password-checklist mt-2">
        <p>密碼需至少包含下列（至少滿足三項）：</p>
        <ul class="text-start">
            <li id="lengthCheck">❌ 密碼長度至少 10 碼（必須）</li>
            <li id="symbolCheck">❌ 至少一個特殊符號（如 !@#）</li>
            <li id="upperCheck">❌ 至少一個大寫英文</li>
            <li id="lowerCheck">❌ 至少一個小寫英文</li>
        </ul>
        </div>

        <!-- 按鈕 -->
        <div class="container-login100-form-btn">
        <div class="wrap-login100-form-btn">
            <div class="login100-form-bgbtn"></div>
            <button class="login100-form-btn">重設</button>
        </div>
        </div>
    </form>
    </div>
</div>
</div>

<!-- JS 套件 -->
<script src="/vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="/vendor/animsition/js/animsition.min.js"></script>
<script src="/vendor/bootstrap/js/popper.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/vendor/select2/select2.min.js"></script>
<script src="/vendor/daterangepicker/moment.min.js"></script>
<script src="/vendor/daterangepicker/daterangepicker.js"></script>
<script src="/vendor/countdowntime/countdowntime.js"></script>
<script src="/js/main.js"></script>

<!-- 驗證邏輯 -->
<script>
function validateForm() {
    return validateEmail() && validatePassword();
}

function validatePassword() {
    const password = document.querySelector('input[name="pass"]').value;

    if (password.length < 10) {
    alert("密碼長度必須至少為 10 碼");
    return false;
    }

    let conditionsMet = 0;
    if (/[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password)) conditionsMet++;
    if (/[A-Z]/.test(password)) conditionsMet++;
    if (/[a-z]/.test(password)) conditionsMet++;

    if (conditionsMet < 2) {
    alert("密碼需至少包含下列三項中的任意兩項：\n1. 特殊符號\n2. 大寫字母\n3. 小寫字母");
    return false;
    }

    return true;
}

// 即時更新：條件列表與強度條
document.addEventListener("DOMContentLoaded", () => {
    const passwordInput = document.querySelector('input[name="pass"]');
    passwordInput.addEventListener("input", () => {
    updateChecklist();
    updateStrengthMeter();
    });
});

function updateChecklist() {
    const password = document.querySelector('input[name="pass"]').value;

    const lengthValid = password.length >= 10;
    const symbolValid = /[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password);
    const upperValid = /[A-Z]/.test(password);
    const lowerValid = /[a-z]/.test(password);

    document.getElementById('lengthCheck').innerHTML = (lengthValid ? "✅" : "❌") + " 密碼長度至少 10 碼";
    document.getElementById('symbolCheck').innerHTML = (symbolValid ? "✅" : "❌") + " 至少一個特殊符號（如 !@#）";
    document.getElementById('upperCheck').innerHTML = (upperValid ? "✅" : "❌") + " 至少一個大寫英文";
    document.getElementById('lowerCheck').innerHTML = (lowerValid ? "✅" : "❌") + " 至少一個小寫英文";
}

function updateStrengthMeter() {
    const password = document.querySelector('input[name="pass"]').value;
    const bar = document.getElementById("strengthBar");
    const text = document.getElementById("strengthText");

    let score = 0;
    if (password.length >= 10) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;

    switch (score) {
    case 0:
        bar.style.width = "0%";
        bar.style.backgroundColor = "#ccc";
        text.textContent = "密碼強度：尚未輸入";
        text.style.color = "#6c757d";
        break;
    case 1:
    case 2:
        bar.style.width = "40%";
        bar.style.backgroundColor = "#dc3545"; // 紅
        text.textContent = "密碼強度：弱";
        text.style.color = "#dc3545";
        break;
    case 3:
        bar.style.width = "70%";
        bar.style.backgroundColor = "#ffc107"; // 橘
        text.textContent = "密碼強度：中";
        text.style.color = "#ffc107";
        break;
    case 4:
    case 5:
        bar.style.width = "100%";
        bar.style.backgroundColor = "#28a745"; // 綠
        text.textContent = "密碼強度：強";
        text.style.color = "#28a745";
        break;
    }
}
async function handleRegister(event) {
  event.preventDefault();

  const password = document.querySelector('input[name="pass"]').value;
  const confirmPassword = document.querySelector('input[name="confirmPass"]').value;
  const token = new URLSearchParams(window.location.search).get("token");

  if (!validatePassword()) return;

  if (password !== confirmPassword) {
    alert("❌ 兩次輸入的密碼不一致！");
    return;
  }

  if (!token) {
    alert("❌ 找不到重設憑證（token）");
    return;
  }

  try {
    const res = await fetch("http://localhost:3000/api/auth/reset-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, newPassword: password })
    });

    const data = await res.json();

    if (res.ok) {
      alert("✅ 密碼重設成功，請重新登入");
      window.location.href = "login.html";
    } else {
      alert("❌ " + (data.message || "重設失敗"));
    }
  } catch (err) {
    console.error(err);
    alert("❌ 伺服器錯誤，請稍後再試");
  }
}
</script>
</body>
</html>