<!DOCTYPE html>
<html data-pc-direction="ltr" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-theme="light" dir="ltr" lang="en">
<!-- [Head] start -->
<head>
	<title>個人檔案</title><!-- [Meta] -->
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" name="viewport">
	<meta content="IE=edge" http-equiv="X-UA-Compatible">
	<meta content="Datta Able is trending dashboard template made using Bootstrap 5 design framework. Datta Able is available in Bootstrap, React, CodeIgniter, Angular, and .net Technologies." name="description">
	<meta content="Bootstrap admin template, Dashboard UI Kit, Dashboard Template, Backend Panel, react dashboard, angular dashboard" name="keywords">
	<meta content="CodedThemes" name="author"><!-- [Favicon] icon -->
	<link href="../assets/images/logo.png" rel="icon" type="image/x-icon"><!-- [Font] Family -->
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"><!-- [phosphor Icons] https://phosphoricons.com/ -->
	<link href="../assets/fonts/phosphor/duotone/style.css" rel="stylesheet"><!-- [Tabler Icons] https://tablericons.com -->
	<link href="../assets/fonts/tabler-icons.min.css" rel="stylesheet"><!-- [Feather Icons] https://feathericons.com -->
	<link href="../assets/fonts/feather.css" rel="stylesheet"><!-- [Font Awesome Icons] https://fontawesome.com/icons -->
	<link href="../assets/fonts/fontawesome.css" rel="stylesheet"><!-- [Material Icons] https://fonts.google.com/icons -->
	<link href="../assets/fonts/material.css" rel="stylesheet"><!-- [Template CSS Files] -->
	<link href="../assets/css/style.css" id="main-style-link" rel="stylesheet">
	<style>
	   .password-checklist li {
	       font-size: 15px;
	       margin-bottom: 4px;
	   }
	   .progress {
	       height: 8px;
	       margin-top: 8px;
	       background-color: #e0e0e0;
	       border-radius: 10px;
	       overflow: hidden;
	   }
	   .progress-bar {
	       transition: width 0.5s ease, background-color 0.4s ease;
	       border-radius: 10px;
	   }
	   #strengthText {
	       transition: color 0.4s ease;
	   }
		/* 確保圖片容器保持正方形 */
		.avatar-container {
            width: 50px;
            height: 50px;
            overflow: hidden;
            border: 1px solid #e2e8f0; /* 灰色邊框 */
            flex-shrink: 0; /* 防止壓縮 */
        }
		/* 預覽大頭貼 */
		.avatar-preview-image {
			max-width: 100px;
			max-height: 100px;
			border: 1px dashed #ccc;
			margin-top: 5px;
		}
		/* 圖片樣式 */
		 #avatar-display {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

	</style>
</head><!-- [Head] end -->
<!-- [Body] Start -->
<body>
	<!-- [ Pre-loader ] start -->
	<div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
		<div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
			<div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
		</div>
	</div><!-- [ Pre-loader ] End -->
	<!-- [ Sidebar Menu ] start -->
	<nav class="pc-sidebar">
		<div class="navbar-wrapper">
			<div class="m-header flex items-center py-4 px-6 h-header-height">
				<a class="b-brand flex items-center gap-3" href="../../index.html"><!-- ========   Change your logo from here   ============ -->
				 <img alt="Logo" class="logo" id="logo" src="../assets/images/logo.png" width="50">
				<p class="text-xl sm:text-3xl font-semibold text-slate-900 dark:text-white">二貨</p></a>
			</div>

			 <!-- 頭像顯示區域 -->
			<div class="m-header flex items-center py-4 px-6 h-header-height">
				<!-- 固定大小的頭像容器 -->
				<div class="avatar-container">
					<img id="avatar-display" 
						src="../assets/images/3.png"
						class="w-full h-full object-cover">
				</div>
				<p class="text-base sm:text-xl font-medium text-slate-900 dark:text-white">您好</p>
			</div>

			<div class="navbar-content h-[calc(100vh_-_74px)] py-2.5">
				<ul class="pc-navbar">
					<li class="pc-item pc-caption"><label>個人檔案</label></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/edit.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="edit"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">修改資料</span></a>
					</li>
					<li class="pc-item"></li>
					<li class="pc-item pc-caption"><label>賣家商場</label> <i data-feather="feather"></i></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/seller/shop.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="shopping-cart"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">進入商場</span></a>
					</li>
					<li class="pc-item pc-caption"><label>買家專區</label> <i data-feather="monitor"></i></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/collect.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="eye"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">檢視收藏</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/order.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="package"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">檢視訂單</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/trade.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="briefcase"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">交易紀錄</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/browse.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="grid"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">瀏覽紀錄</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/point.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="feather"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">環保點數</span></a>
					</li>
					<li class="pc-item pc-caption"><label>其他</label> <i data-feather="sidebar"></i></li>
					<li class="pc-item">
						<a class="pc-link" href="../../index.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="home"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">回首頁</span></a>
					</li>
					<li class="pc-item">
						<a class="pc-link" href="../../index.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="log-out"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">登出</span></a>
					</li>
				</ul>
			</div>
		</div>
	</nav><!-- [ Sidebar Menu ] end -->
	<!-- [ Header Topbar ] start -->
	<header class="pc-header">
		<div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow">
			<!-- [Mobile Media Block] start -->
			<!-- [Mobile Media Block end] -->
			<div class="ms-auto">
				<ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
					<li class="dropdown pc-h-item">
						<a aria-expanded="false" aria-haspopup="false" class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button"><i data-feather="sun"></i></a>
						<div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
							<a class="dropdown-item" href="#!" onclick="layout_change('dark')"><i data-feather="moon"></i> <span>深色</span></a> <a class="dropdown-item" href="#!" onclick="layout_change('light')"><i data-feather="sun"></i> <span>明亮</span></a>
						</div>
					</li>
				</ul>
			</div>
		</div>
	</header><!-- [ Header ] end -->
	<!-- [ Main Content ] start -->
	<div class="pc-container">
		<div class="pc-content">
			<!-- [ breadcrumb ] start -->
			<div class="page-header">
				<div class="page-block">
					<div class="page-header-title">
						<h5 class="mb-0 font-medium">位置</h5>
					</div>
					<ul class="breadcrumb">
						<li class="breadcrumb-item">
							<a href="/index.html">回首頁</a>
						</li>
						<li class="breadcrumb-item">
							<a href="/dashboard/profile.html">個人檔案</a>
						</li>
						<li class="breadcrumb-item">修改資料</li>
					</ul>
				</div>
			</div><!-- [ Main Content ] start -->
			<!-- [ Profile Form ] start -->
			<div class="row">
				<div class="col-12 xl:col-8">
					<div class="card">
						<div class="card-header">
							<h5 class="mb-0">修改個人資料</h5>
						</div>
						<div class="card-body">
							<form id="profileForm" name="profileForm" onsubmit="return false;">
								<!-- 姓名 -->
								<div class="mb-4">
									<label class="form-label">姓名</label> <input class="form-control" id="name" name="name" type="text" value="">
								</div><!-- 信箱 -->
								<div class="mb-4">
									<label class="form-label">學校信箱 (@ntub.edu.tw)</label> <input class="form-control" id="email" name="email" type="email" value="">
								</div>
								<div>
									<button class="btn btn-primary" id="updateProfileBtn" type="button">修改姓名/信箱</button>
								</div><br>
								<!-- 舊密碼驗證 -->
								<div class="mb-4">
									<input class="form-control" id="old_password" name="old_password" placeholder="請輸入舊密碼" type="password"> <button class="btn btn-primary" id="verifyOldPasswordBtn" type="button">驗證舊密碼</button>
								</div><!-- 新密碼 -->
								<div id="newPasswordSection" style="display: none;">
									<div class="mb-4">
										<label class="form-label">新密碼</label> <input class="form-control" name="pass" placeholder="請輸入新密碼" type="password">
        								<label class="form-label mt-3">確認新密碼</label> <input class="form-control" name="pass2" placeholder="請再次輸入新密碼" type="password">
										<ul class="password-checklist mt-2">
											<li id="lengthCheck">❌ 密碼長度至少 10 碼</li>
											<li id="symbolCheck">❌ 至少一個特殊符號（如 !@#）</li>
											<li id="upperCheck">❌ 至少一個大寫英文</li>
											<li id="lowerCheck">❌ 至少一個小寫英文</li>
										</ul>
										<div class="progress">
											<div class="progress-bar" id="strengthBar" style="width: 0%;"></div>
										</div>
										<p class="mt-2" id="strengthText">密碼強度：尚未輸入</p>
									</div><button class="btn btn-primary" id="changePasswordBtn" type="button">修改密碼</button>
								</div>
								<!-- 頭像上傳 -->
								<div class="mb-4">
									<label class="form-label">頭像上傳</label>
									<input class="form-control" id="avatarInput" type="file" accept="image/jpeg, image/png, image/webp">
									<button class="btn btn-primary mt-2" id="changeAvatarBtn" type="button">更新頭像</button>
									<!-- 預覽區域 (可視化預覽時移除style) -->
									<div id="avatar-preview-container" style="display:none; margin-top:10px;">
										<p class="text-sm text-gray-500">預覽：</p>
										<img id="avatar-preview" class="avatar-preview-image">
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div><!-- [ Profile Form ] end -->
		</div>
	</div><!-- [ Main Content ] end -->
	<!-- [ Main Content ] start -->
	<!-- [ Main Content ] end -->
	<footer class="pc-footer"></footer><!-- Required Js -->
	<script src="../assets/js/plugins/simplebar.min.js">
	</script> 
	<script src="../assets/js/plugins/popper.min.js">
	</script> 
	<script src="../assets/js/icon/custom-icon.js">
	</script> 
	<script src="../assets/js/plugins/feather.min.js">
	</script> 
	<script src="../assets/js/component.js">
	</script> 
	<script src="../assets/js/theme.js">
	</script> 
	<script src="../assets/js/script.js">
	</script>
	<div class="floting-button fixed bottom-[50px] right-[30px] z-[1030]"></div>
	<script>
	     layout_change('false');
	</script> 
	<script>
	     layout_theme_sidebar_change('dark');
	</script> 
	<script>
	     change_box_container('false');
	</script> 
	<script>
	     layout_caption_change('true');
	</script> 
	<script>
	     layout_rtl_change('false');
	</script> 
	<script>
	     preset_change('preset-1');
	</script> 
	<script>
	     main_layout_change('vertical');
	</script> 
	<script src="../../vendor/jquery/jquery-3.2.1.min.js">
	</script> 
	<script src="../../vendor/animsition/js/animsition.min.js">
	</script> 
	<script src="../../vendor/bootstrap/js/popper.js">
	</script> 
	<script src="../../vendor/bootstrap/js/bootstrap.min.js">
	</script> 
	<script src="../../vendor/select2/select2.min.js">
	</script> 
	<script src="../../vendor/daterangepicker/moment.min.js">
	</script> 
	<script src="../../vendor/daterangepicker/daterangepicker.js">
	</script> 
	<script src="../../vendor/countdowntime/countdowntime.js">
	</script> 
	<script src="../js/main.js">
	</script> 
	<script>
	     document.addEventListener("DOMContentLoaded", async () => {
	       try {
	         const res = await fetch("http://localhost:3000/api/user/profile", {
	           method: "GET",
	           headers: {
	             Authorization: `Bearer ${localStorage.getItem("token")}`,
	           },
	         });

	         if (!res.ok) throw new Error("無法載入使用者資料");

	         const data = await res.json();
	         document.getElementById("name").value = data.name || "";
	         document.getElementById("email").value = data.email || "";
	       } catch (err) {
	         console.error("載入資料失敗：", err);
	         alert("無法載入個人資料，請稍後再試");
	       }
	     });
	</script> <!-- 驗證邏輯 -->
	 
	<script>
	   function validateForm() {
	       return validateEmail() && validatePassword();
	   }

	   function validateEmail() {
	       const emailInput = document.getElementById("email").value.trim();
	       const regex = /^[a-zA-Z0-9._%+-]+@ntub\.edu\.tw$/;
	       if (!regex.test(emailInput)) {
	       alert("請輸入 ntub.edu.tw 的學校信箱！");
	       return false;
	       }
	       return true;
	   }

	   function validatePassword() {
	       const password = document.querySelector('input[name="pass"]').value;

	       if (password.length < 10) {
	       alert("密碼長度必須至少為 10 碼");
	       return false;
	       }

	       let conditionsMet = 0;
	       if (/[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password)) conditionsMet++;
	       if (/[A-Z]/.test(password)) conditionsMet++;
	       if (/[a-z]/.test(password)) conditionsMet++;

	       if (conditionsMet < 2) {
	       alert("密碼需至少包含下列三項中的任意兩項：\n1. 特殊符號\n2. 大寫字母\n3. 小寫字母");
	       return false;
	       }

	       return true;
	   }

	   // 即時更新：條件列表與強度條
	   document.addEventListener("DOMContentLoaded", () => {
	       const passwordInput = document.querySelector('input[name="pass"]');
	       passwordInput.addEventListener("input", () => {
	       updateChecklist();
	       updateStrengthMeter();
	       });
	   });

	   function updateChecklist() {
	       const password = document.querySelector('input[name="pass"]').value;

	       const lengthValid = password.length >= 10;
	       const symbolValid = /[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password);
	       const upperValid = /[A-Z]/.test(password);
	       const lowerValid = /[a-z]/.test(password);

	       document.getElementById('lengthCheck').innerHTML = (lengthValid ? "✅" : "❌") + " 密碼長度至少 10 碼";
	       document.getElementById('symbolCheck').innerHTML = (symbolValid ? "✅" : "❌") + " 至少一個特殊符號（如 !@#）";
	       document.getElementById('upperCheck').innerHTML = (upperValid ? "✅" : "❌") + " 至少一個大寫英文";
	       document.getElementById('lowerCheck').innerHTML = (lowerValid ? "✅" : "❌") + " 至少一個小寫英文";
	   }

	   function updateStrengthMeter() {
	       const password = document.querySelector('input[name="pass"]').value;
	       const bar = document.getElementById("strengthBar");
	       const text = document.getElementById("strengthText");

	       let score = 0;
	       if (password.length >= 10) score++;
	       if (/[A-Z]/.test(password)) score++;
	       if (/[a-z]/.test(password)) score++;
	       if (/[!@#$%^&*(),.?":{}|<>_\-+=~`[\]\\\/]/.test(password)) score++;
	       if (/[0-9]/.test(password)) score++;

	       switch (score) {
	       case 0:
	           bar.style.width = "0%";
	           bar.style.backgroundColor = "#ccc";
	           text.textContent = "密碼強度：尚未輸入";
	           text.style.color = "#6c757d";
	           break;
	       case 1:
	       case 2:
	           bar.style.width = "40%";
	           bar.style.backgroundColor = "#dc3545"; // 紅
	           text.textContent = "密碼強度：弱";
	           text.style.color = "#dc3545";
	           break;
	       case 3:
	           bar.style.width = "70%";
	           bar.style.backgroundColor = "#ffc107"; // 橘
	           text.textContent = "密碼強度：中";
	           text.style.color = "#ffc107";
	           break;
	       case 4:
	       case 5:
	           bar.style.width = "100%";
	           bar.style.backgroundColor = "#28a745"; // 綠
	           text.textContent = "密碼強度：強";
	           text.style.color = "#28a745";
	           break;
	       }
	   }
	</script> 
	<script>
	   const logo = document.getElementById("logo");
	   function updateLogo() {
	     const isDark = document.documentElement.getAttribute("data-pc-theme") === "dark";
	     logo.src = isDark ? "../assets/images/logo-w.png" : "../assets/images/logo.png";
	   }

	   // 初始設定一次
	   updateLogo();

	   // 監聽深色模式切換
	   const darkModeObserver = new MutationObserver(updateLogo);
	   darkModeObserver.observe(document.documentElement, {
	     attributes: true,
	     attributeFilter: ["data-pc-theme"]
	   });
	</script> 
	<script>
	   const API_BASE = "http://localhost:3000/api/user";
	   //修改名稱和email
	     document.getElementById('updateProfileBtn').addEventListener('click', async () => {
	     const name = document.getElementById('name').value.trim();
	     const email = document.getElementById('email').value.trim();

	     if (!name || !email) {
	         alert('姓名與信箱不能為空');
	         return;
	     }

	     try {
	         const res = await fetch(`${API_BASE}/profile`, {
	             method: 'PATCH',
	             headers: {
	                 'Content-Type': 'application/json',
	                 'Authorization': `Bearer ${localStorage.getItem('token')}`
	             },
	             body: JSON.stringify({ name, email })
	         });

	         const data = await res.json();
	         if (data.success) {
	             alert('資料更新成功');
	         } else {
	             alert(data.message || '更新失敗');
	         }
	     } catch (err) {
	         console.error(err);
	         alert('伺服器錯誤');
	     }
	 });

	   // ======================= 舊密碼驗證 =======================
		document.getElementById("verifyOldPasswordBtn").addEventListener("click", async () => {
			const oldPassword = document.getElementById("old_password").value.trim();
			
			if (!oldPassword) {
				alert("請輸入舊密碼");
				return;
			}

			try {
				const res = await fetch(`${API_BASE}/verify-password`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"Authorization": `Bearer ${localStorage.getItem("token")}`
					},
					body: JSON.stringify({ oldPassword }) // 注意這裡欄位名稱要和後端一致
				});

				const data = await res.json();
				
				if (!res.ok) {
					throw new Error(data.message || "驗證失敗");
				}

				if (data.success) {
					alert("舊密碼正確，請輸入新密碼");
					document.getElementById("newPasswordSection").style.display = "block";
				} else {
					alert(data.message || "舊密碼錯誤");
				}
			} catch (err) {
				console.error("驗證錯誤:", err);
				alert(err.message || "伺服器錯誤，請稍後再試");
			}
		});

	   
	   // ======================= 新密碼驗證 & 修改 =======================
	   function validatePassword() {
			const pass = document.querySelector('input[name="pass"]').value;
			const pass2 = document.querySelector('input[name="pass2"]').value;

			// 驗證規則需與 HTML 中的提示完全一致
			if (pass.length < 10) {  // 修改為 10 碼
				alert("密碼長度至少 10 位數");
				return false;
			}
			if (!/[!@#$%^&*]/.test(pass)) {  // 特殊符號檢查
				alert("密碼需包含至少一個特殊符號（如 !@#$%^&*）");
				return false;
			}
			if (!/[A-Z]/.test(pass)) {  // 大寫字母檢查
				alert("密碼需包含至少一個大寫英文");
				return false;
			}
			if (!/[a-z]/.test(pass)) {  // 小寫字母檢查
				alert("密碼需包含至少一個小寫英文");
				return false;
			}
			if (pass !== pass2) {
				alert("兩次輸入的密碼不一致");
				return false;
			}
			return true;
		}

		document.getElementById("changePasswordBtn").addEventListener("click", async () => {
			if (!validatePassword()) return;

			const oldPassword = document.getElementById("old_password").value.trim();
			const newPassword = document.querySelector('input[name="pass"]').value;

			try {
				const res = await fetch(`${API_BASE}/change-password`, {
					method: "PATCH",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${localStorage.getItem("token")}`,
					},
					body: JSON.stringify({ 
						oldPassword, 
						newPassword 
					}),
				});

				const data = await res.json();
				if (data.success) {
					alert("密碼修改成功，請重新登入");
					localStorage.removeItem("token");
					window.location.href = "/login.html";
				} else {
					alert(data.message || "密碼修改失敗");
				}
			} catch (err) {
				console.error("密碼修改錯誤:", err);
				alert("伺服器錯誤，請稍後再試");
			}
		});

	 // ======================= 頭像修改 (終極修正版) =======================
		let selectedFile = null;
		const avatarElement = document.getElementById("avatar-display");
		const defaultAvatar = "../assets/images/3.png";

		// 初始化
		function initAvatar() {
			loadSavedAvatar();
			
			document.getElementById("avatarInput").addEventListener("change", function(e) {
				const file = e.target.files[0];
				if (file && validateImageFile(file)) {
					selectedFile = file;
					previewImage(file);
					document.getElementById("avatar-preview-container").style.display = "block";
				}
			});
			
			document.getElementById("changeAvatarBtn").addEventListener("click", uploadAvatar);
		}

		// 驗證圖片檔案
		function validateImageFile(file) {
			const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
			const maxSizeMB = 2;
			
			if (!allowedTypes.includes(file.type)) {
				alert(`只允許上傳 ${allowedTypes.join('/')} 格式的圖片`);
				return false;
			}

			if (file.size > maxSizeMB * 1024 * 1024) {
				alert(`圖片大小超過 ${maxSizeMB}MB 限制`);
				return false;
			}

			return true;
		}

		// 預覽圖片
		function previewImage(file) {
			const reader = new FileReader();
			reader.onload = function(e) {
				const previewImg = document.getElementById("avatar-preview");
				previewImg.src = e.target.result;
			};
			reader.readAsDataURL(file);
		}

		// 修改後的上傳邏輯
		async function uploadAvatar() {
			if (!selectedFile) {
				console.log("未選擇文件");
				alert("請先選擇一張圖片");
				return;
			}

			try {
				console.group(" 開始上傳頭像");
				console.log("選中文件:", selectedFile.name, "大小:", (selectedFile.size / 1024).toFixed(2), "KB");
				
				const btn = document.getElementById("changeAvatarBtn");
				btn.disabled = true;
				btn.textContent = "上傳中...";
				console.log("按鈕狀態已禁用");

				const formData = new FormData();
				formData.append("avatar", selectedFile);
				console.log(" FormData 已創建");

				console.log(" 發送請求到:", `${API_BASE}/avatar`);
				const response = await fetch(`${API_BASE}/avatar`, {
				method: "PATCH",
				headers: {
					Authorization: `Bearer ${localStorage.getItem("token")}`,
				},
				body: formData
				});

				console.log(" 服務器響應狀態:", response.status);
				
				if (!response.ok) {
				const errorData = await response.json();
				console.error(" 服務器返回錯誤:", errorData);
				throw new Error(errorData.message || "上傳失敗");
				}

				const result = await response.json();
				console.log("服務器返回數據:", result);
				
				if (result.success) {
				console.log("頭像URL:", result.avatarUrl);
				updateProfileAvatar(result.avatarUrl);
				alert("頭像更新成功！");
				console.log("頭像更新完成");
				} else {
				console.error(" 服務器返回異常數據:", result);
				throw new Error(result.message || "伺服器返回數據異常");
				}
			} catch (error) {
				console.groupCollapsed(" 上傳過程中發生錯誤");
				console.error("錯誤詳情:", error);
				console.trace(); // 打印調用堆棧
				console.groupEnd();
				
				alert(`上傳失敗: ${error.message}`);
				resetAvatar();
				console.log("已重置為默認頭像");
			} finally {
				resetUploadState();
				console.log("上傳狀態已重置");
				console.groupEnd();
			}
		}
		// 修改後的核心功能 (移除多餘的 URL 構建和驗證)
		async function updateProfileAvatar(avatarUrl) {
			if (!avatarUrl) {
				resetAvatar();
				return;
			}

			// 添加時間戳強制刷新
			const timestamp = new Date().getTime();
			avatarElement.src = `${avatarUrl}?t=${timestamp}`;
			localStorage.setItem("userAvatar", avatarUrl);
			
			// 強制重繪（確保 DOM 更新）
			triggerDomRepaint(avatarElement);
		}


		// 強制DOM重繪
		function triggerDomRepaint(element) {
			element.style.display = 'none';
			void element.offsetHeight; // 觸發重繪
			element.style.display = 'block';
		}

		// 載入已保存頭像
		function loadSavedAvatar() {
			const savedAvatar = localStorage.getItem("userAvatar");
			if (savedAvatar) {
				updateProfileAvatar(savedAvatar).catch(() => {
					console.warn("載入保存的頭像失敗，恢復默認頭像");
					resetAvatar();
				});
			}
		}

		// 重置頭像
		function resetAvatar() {
			avatarElement.src = defaultAvatar;
			localStorage.removeItem("userAvatar");
		}

		// 重置上傳狀態
		function resetUploadState() {
			selectedFile = null;
			document.getElementById("avatarInput").value = '';
			document.getElementById("avatar-preview-container").style.display = "none";
			
			const btn = document.getElementById("changeAvatarBtn");
			btn.disabled = false;
			btn.textContent = "更新頭像";
		}

		// 初始化
		document.addEventListener("DOMContentLoaded", initAvatar);
	</script><!-- [Body] end -->
</body>
</html>