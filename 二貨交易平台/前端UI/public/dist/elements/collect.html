<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <!-- [Head] start -->
  <head>
    <title>個人檔案 - 檢視收藏</title>
    <!-- [Meta] -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="description"
      content="二貨 - 校園二手交易平台"
    />
    <meta
      name="keywords"
      content="二手交易, 校園, 環保, 買賣"
    />
    <meta name="author" content="二貨團隊" />

    <!-- [Favicon] icon -->
    <link href="../assets/images/logo.png" rel="icon" type="image/x-icon">

    <!-- [Font] Family -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <!-- [phosphor Icons] https://phosphoricons.com/ -->
    <link rel="stylesheet" href="../assets/fonts/phosphor/duotone/style.css" />
    <!-- [Tabler Icons] https://tablericons.com -->
    <link rel="stylesheet" href="../assets/fonts/tabler-icons.min.css" />
    <!-- [Feather Icons] https://feathericons.com -->
    <link rel="stylesheet" href="../assets/fonts/feather.css" />
    <!-- [Font Awesome Icons] https://fontawesome.com/icons -->
    <link rel="stylesheet" href="../assets/fonts/fontawesome.css" />
    <!-- [Material Icons] https://fonts.google.com/icons -->
    <link rel="stylesheet" href="../assets/fonts/material.css" />
    <!-- [Bootstrap Icons] -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- [Template CSS Files] -->
    <link rel="stylesheet" href="../assets/css/style.css" id="main-style-link" />
    <style>
      /* 確保圖片容器保持正方形 */
		  .avatar-container {
          width: 50px;
          height: 50px;
          overflow: hidden;
          border: 1px solid #e2e8f0; /* 灰色邊框 */
          flex-shrink: 0; /* 防止壓縮 */
      }
		  /* 預覽大頭貼 */
      .avatar-preview-image {
          max-width: 100px;
          max-height: 100px;
          border: 1px dashed #ccc;
          margin-top: 5px;
      }
		  /* 圖片樣式 */
      #avatar-display {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
      }
      /* 收藏按鈕樣式 */
      .favorite-btn {
          position: absolute;
          top: 10px;
          left: 10px;
          background: rgba(255, 255, 255, 0.9);
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 10;
          transition: all 0.3s ease;
      }
      .favorite-btn:hover {
          background: rgba(255, 255, 255, 1);
          transform: scale(1.1);
      }
      .favorite-btn i {
          font-size: 18px;
          color: #ccc; /* 預設灰色空心 */
      }
      .favorite-btn.favorited i {
          color: #dc3545; /* 收藏後紅色實心 */
      }
      
      /* 商品卡片樣式優化 */
      .product-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .product-image {
        height: 200px;
        object-fit: cover;
        width: 100%;
      }
      .product-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .product-description {
        color: #6c757d;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      .product-price {
        font-weight: bold;
        color: #dc3545;
        font-size: 1.2rem;
      }
      .product-location {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
      }
      .product-category {
        font-size: 0.8rem;
        background-color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 0.5rem;
      }
      /* 商品狀態 */
      .product-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
      }
      /* 加載動畫 */
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6474E1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* 空狀態樣式 */
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
      }
      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dee2e6;
      }
    </style>
  </head>
  <!-- [Head] end -->
  
  <!-- [Body] Start -->
  <body>
    <!-- [ Pre-loader ] start -->
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>
    <!-- [ Pre-loader ] End -->
    
    <!-- 側邊欄導航 -->
    <nav class="pc-sidebar">
      <div class="navbar-wrapper">
			<div class="m-header flex items-center py-4 px-6 h-header-height">
				<a class="b-brand flex items-center gap-3" href="../../index.html"><!-- ========   Change your logo from here   ============ -->
				 <img alt="Logo" class="logo" id="logo" src="../assets/images/logo.png" width="50">
				<p class="text-xl sm:text-3xl font-semibold text-slate-900 dark:text-white">二貨</p></a>
			</div>

			<!-- 頭像顯示區域 -->
      <div class="m-header flex items-center py-4 px-6 h-header-height">
          <!-- 頭像容器 - 添加加載狀態處理 -->
          <div class="avatar-container relative w-12 h-12 rounded-full overflow-hidden">
              <img id="avatar-display" 
                  src="../assets/images/3.png"
                  class="w-full h-full object-cover"
                  onerror="this.src='../assets/images/3.png'">
              <div id="avatar-loader" class="hidden absolute inset-0 bg-gray-200 animate-pulse"></div>
          </div>
          <p class="text-base sm:text-xl font-medium text-slate-900 dark:text-white">您好</p>
      </div>

			<div class="navbar-content h-[calc(100vh_-_74px)] py-2.5">
				<ul class="pc-navbar">
					<li class="pc-item pc-caption"><label>個人檔案</label></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/edit.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="edit"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">修改資料</span></a>
					</li>
					<li class="pc-item"></li>
					<li class="pc-item pc-caption"><label>賣家商場</label> <i data-feather="feather"></i></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/seller/shop.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="shopping-cart"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">進入商場</span></a>
					</li>
					<li class="pc-item pc-caption"><label>買家專區</label> <i data-feather="monitor"></i></li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/collect.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="eye"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">檢視收藏</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/order.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="package"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">檢視訂單</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/trade.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="briefcase"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">交易紀錄</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/browse.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="grid"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">瀏覽紀錄</span></a>
					</li>
					<li class="pc-item pc-hasmenu">
						<a class="pc-link" href="../elements/point.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="feather"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">環保點數</span></a>
					</li>
					<li class="pc-item pc-caption"><label>其他</label> <i data-feather="sidebar"></i></li>
					<li class="pc-item">
						<a class="pc-link" href="../../index.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="home"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">回首頁</span></a>
					</li>
					<li class="pc-item">
						<a class="pc-link" href="../../index.html"><span class="pc-micon" style="color: rgba(100, 100, 159, 100);"><i data-feather="log-out"></i></span> <span class="pc-mtext" style="color: rgba(100, 100, 159, 100);">登出</span></a>
					</li>
				</ul>
			</div>
		</div>
    </nav>
    
    <!-- 頂部導航欄 -->
    <header class="pc-header">
      <div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow"><!-- [Mobile Media Block] start -->
        <div class="me-auto pc-mob-drp">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <!-- ======= Menu collapse Icon ===== -->
            <li class="pc-h-item pc-sidebar-collapse max-lg:hidden lg:inline-flex">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="sidebar-hide">
                <i data-feather="menu"></i>
              </a>
            </li>
            <li class="pc-h-item pc-sidebar-popup lg:hidden">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="mobile-collapse">
                <i data-feather="menu"></i>
              </a>
            </li>
          </ul>
        </div>
        <!-- [Mobile Media Block end] -->
        <div class="ms-auto">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button"
                aria-haspopup="false" aria-expanded="false">
                <i data-feather="sun"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item" onclick="layout_change('dark')">
                  <i data-feather="moon"></i>
                  <span>深色</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change('light')">
                  <i data-feather="sun"></i>
                  <span>明亮</span>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <div class="pc-content">
        <!-- 麵包屑導航 -->
        <div class="page-header">
          <div class="page-block">
            <div class="page-header-title">
              <h5 class="mb-0 font-medium">位置</h5>
            </div>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="../../index.html">回首頁</a></li>
              <li class="breadcrumb-item"><a href="../dashboard/profile.html">個人檔案</a></li>
              <li class="breadcrumb-item">檢視收藏</li>
            </ul>
          </div>
        </div>
        <!-- [ breadcrumb ] end -->

        <div>
          <h3>檢視收藏</h3>
          <p class="text-muted">您收藏的商品將會顯示在這裡</p>
        </div>
        
        <!-- 商品加載狀態 -->
        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner"></div>
        </div>
        
        <!-- 空狀態 -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <i class="bi bi-heart"></i>
          <h4>尚未收藏任何商品</h4>
          <p>開始瀏覽商品並將喜歡的加入收藏吧！</p>
          <div class="mt-3">
            <a href="../../index.html" class="btn btn-primary me-2">去逛逛</a>
            <button onclick="loadFavoriteItems()" class="btn btn-outline-primary">重新載入</button>
          </div>
        </div>
        
        <!-- 商品列表 -->
        <div class="grid grid-cols-12 gap-6 mt-4" id="favoritesContainer">
          <!-- 商品卡片將在這裡動態生成 -->
        </div>
      </div>
    </div>
    <!-- [ Main Content ] end -->
    
    <footer class="pc-footer">
    </footer>

    <!-- Required Js -->
    <script src="../assets/js/plugins/simplebar.min.js"></script>
    <script src="../assets/js/plugins/popper.min.js"></script>
    <script src="../assets/js/icon/custom-icon.js"></script>
    <script src="../assets/js/plugins/feather.min.js"></script>
    <script src="../assets/js/component.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // API基礎URL
      const API_BASE = 'http://localhost:3000';
      
      // 分類名稱映射
      const CATEGORY_MAPPING = {
        1: '電子產品',
        2: '生活用品',
        3: '書籍',
        4: '運動用品',
        5: '服飾',
        6: '周邊'
      };
      
      // 全局變量
      let favoriteItems = [];
      
      // 頁面載入時執行
      document.addEventListener('DOMContentLoaded', function() {
        loadFavoriteItems();
        
        // 初始化Feather圖標
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      });
      
      // 顯示加載狀態
      function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const container = document.getElementById('favoritesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (show) {
          spinner.style.display = 'flex';
          container.style.display = 'none';
          emptyState.style.display = 'none';
        } else {
          spinner.style.display = 'none';
        }
      }

      // 顯示空狀態
      function showEmptyState() {
        const container = document.getElementById('favoritesContainer');
        const emptyState = document.getElementById('emptyState');
        const spinner = document.getElementById('loadingSpinner');
        
        spinner.style.display = 'none';
        container.style.display = 'none';
        emptyState.style.display = 'block';
      }

      // 顯示商品列表
      function showItems() {
        const container = document.getElementById('favoritesContainer');
        const emptyState = document.getElementById('emptyState');
        const spinner = document.getElementById('loadingSpinner');
        
        spinner.style.display = 'none';
        container.style.display = 'grid';
        emptyState.style.display = 'none';
      }
      
      // 從API獲取收藏商品
      async function loadFavoriteItems() {
        try {
          showLoading(true);
          
          console.log('開始加載收藏商品...'); // 调试信息
          
          const token = localStorage.getItem('token');
          if (!token) {
            console.log('未找到token，顯示空狀態');
            showEmptyState();
            showLoading(false);
            return;
          }
          
          const response = await fetch(`${API_BASE}/api/favorite/list`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          // 处理未授权情况
          if (response.status === 401) {
            console.log('Token已過期，顯示空狀態');
            localStorage.removeItem('token');
            showEmptyState();
            Swal.fire('請重新登入', '登入狀態已過期', 'warning');
            showLoading(false);
            return;
          }
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          console.log('API回應:', result); // 调试信息
          
          if (result.data && Array.isArray(result.data)) {
            favoriteItems = result.data;
            console.log(`獲取到 ${favoriteItems.length} 個收藏商品`); // 调试信息
            
            if (favoriteItems.length > 0) {
              console.log('有收藏商品，顯示商品列表');
              renderFavoriteItems();
              showItems();
            } else {
              console.log('沒有收藏商品，顯示空狀態');
              showEmptyState();
            }
          } else {
            console.log('API返回數據格式不正確，顯示空狀態');
            showEmptyState();
          }
          
          showLoading(false);
        } catch (error) {
          console.error('獲取收藏商品失敗:', error);
          showLoading(false);
          showEmptyState();
          Swal.fire('錯誤', '無法載入收藏商品，請稍後再試', 'error');
        }
      }
      
      // 渲染收藏商品
      function renderFavoriteItems() {
        const container = document.getElementById('favoritesContainer');
        container.innerHTML = '';
        
        favoriteItems.forEach(item => {
          const col = document.createElement('div');
          col.className = 'col-span-12 md:col-span-6 lg:col-span-4';
          
          // 處理圖片URL
          let imageUrl = '../assets/images/3.png'; // 預設圖片
          if (item.image_url) {
            if (item.image_url.startsWith('http')) {
              imageUrl = item.image_url;
            } else if (item.image_url.startsWith('/')) {
              imageUrl = `${API_BASE}/uploads${item.image_url}`;
            } else {
              imageUrl = `${API_BASE}/${item.image_url}`;
            }
          }
          
          col.innerHTML = `
            <div class="card product-card">
              <div class="relative">
                <!-- 收藏按鈕 -->
                <button class="favorite-btn favorited" onclick="toggleFavorite(${item.id}, this)">
                  <i class="bi bi-heart-fill"></i>
                </button>
                
                <!-- 商品圖片 -->
                <img src="${imageUrl}" alt="${item.name}" class="product-image" 
                    onerror="this.src='../assets/images/3.png'">
              </div>
              
              <div class="card-body">
                <!-- 商品分類 -->
                <span class="product-category">${CATEGORY_MAPPING[item.category_id] || '未分類'}</span>
                <span class="badge ${item.status === 'available' ? 'bg-green-500' : 'bg-gray-500'} text-white product-status">
                  ${item.status === 'available' ? '可購買' : item.status}
                </span>
                                
                <!-- 商品名稱 -->
                <h5 class="product-title">${item.name}</h5>
                
                <!-- 商品描述 -->
                ${item.description ? `<p class="product-description">${item.description}</p>` : ''}
                
                <!-- 交易地點 -->
                <p class="product-location">
                  <i class="bi bi-geo-alt"></i> ${item.location || '未指定地點'}
                </p>
                
                <div class="flex items-center justify-between mt-3">
                  <!-- 商品價格 -->
                  <span class="product-price">$${formatPrice(item.price)}</span>
                  
                  <!-- 購買按鈕 -->
                  <button class="btn btn-primary" 
                          ${item.status !== 'available' ? 'disabled' : ''}
                          onclick="confirmPurchase(${item.id}, '${escapeHtml(item.name)}', ${item.price}, '${escapeHtml(imageUrl)}', '${escapeHtml(item.location)}')">
                    <i class="bi bi-cart-plus me-1"></i> 
                    ${item.status === 'available' ? '購買' : '已售出'}
                  </button>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(col);
        });
      }
      
      // 添加確認函數
      function confirmPurchase(itemId, itemName, price, imageUrl, location) {
        Swal.fire({
          title: '確認購買？',
          text: `您即將購買「${itemName}」`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '確認',
          cancelButtonText: '取消'
        }).then((result) => {
          if (result.isConfirmed) {
            showPurchasePopup(itemId, itemName, price, imageUrl, location);
          }
        });
      }
      
      // 切換收藏狀態
      async function toggleFavorite(itemId, button) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            Swal.fire('請先登入', '需要登入才能管理收藏', 'warning');
            return;
          }
          
          // 這裡假設取消收藏的API端點
          const response = await fetch(`${API_BASE}/api/favorite/remove/${itemId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            // 直接移除對應的商品卡片
            const itemElement = button.closest('.col-span-12');
            if (itemElement) {
              itemElement.remove();
            }

            // 更新本地列表
            favoriteItems = favoriteItems.filter(item => item.id !== itemId);

            // 檢查是否還有其他收藏商品
            if (favoriteItems.length === 0) {
              showEmptyState();
            }
            
            Swal.fire('成功', '已從收藏中移除', 'success');
          } else {
            throw new Error('取消收藏失敗');
          }
        } catch (error) {
          console.error('取消收藏失敗:', error);
          Swal.fire('錯誤', '取消收藏失敗，請稍後再試', 'error');
        }
      }

      // ======================= 頭像獲取與顯示 =======================
      document.addEventListener("DOMContentLoaded", async function() {
          const avatarElement = document.getElementById("avatar-display");
          const defaultAvatar = "../assets/images/3.png"; // 預設頭像路徑
          
          try {
              // 1. 先檢查本地緩存
              const cachedAvatar = localStorage.getItem("userAvatar");
              if (cachedAvatar) {
                  avatarElement.src = cachedAvatar;
                  return; // 如果有緩存就直接使用
              }
              
              // 2. 從API獲取頭像URL
              const response = await fetch(`${API_BASE}/user/avatar`, {
                  headers: {
                      'Authorization': `Bearer ${localStorage.getItem("token")}`
                  }
              });
              
              if (response.ok) {
                  const data = await response.json();
                  if (data.avatarUrl) {
                      // 添加時間戳避免緩存問題
                      const avatarUrl = `${data.avatarUrl}?t=${new Date().getTime()}`;
                      avatarElement.src = avatarUrl;
                      localStorage.setItem("userAvatar", avatarUrl); // 緩存到本地
                  }
              } else {
                  throw new Error("獲取頭像失敗");
              }
          } catch (error) {
              console.error("頭像加載錯誤:", error);
              avatarElement.src = defaultAvatar; // 失敗時使用預設頭像
          }
      });
      
      // 顯示購買確認彈窗
      function showPurchasePopup(itemId, itemName, price, imageUrl, location) {
        Swal.fire({
          title: `確認購買「${itemName}」？`,
          html: `
            <div class="text-start">
              <p><strong>價格：</strong>$${price.toLocaleString()}</p>
              <p><strong>交易地點：</strong>${location}</p>
              <img src="${imageUrl}" alt="${itemName}" 
                  style="max-width: 100%; border-radius: 8px; margin-top: 10px;"
                  onerror="this.src='../assets/images/3.png'">
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: '確認購買',
          cancelButtonText: '取消',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          showLoaderOnConfirm: true,
          preConfirm: async () => {
            try {
              const token = localStorage.getItem('token');
              if (!token) {
                throw new Error('請先登入');
              }
              
              // 使用正確的API端點 - 創建訂單
              const response = await fetch(`${API_BASE}/api/order/create`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                  item_id: itemId,
                  price: price,
                  location: location
                })
              });
              
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || '購買失敗');
              }
              
              return await response.json();
            } catch (error) {
              Swal.showValidationMessage(`購買失敗: ${error.message}`);
              return false;
            }
          },
          allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
          if (result.isConfirmed) {
            // 購買成功後更新商品狀態
            updateItemStatusAfterPurchase(itemId);
            
            Swal.fire({
              title: '✅ 購買成功！',
              html: `
                <div class="text-start">
                  <p>「${itemName}」已成功購買。</p>
                  <p><strong>訂單詳情：</strong></p>
                  <p>• 價格: $${price.toLocaleString()}</p>
                  <p>• 交易地點: ${location}</p>
                  <p class="text-sm text-muted mt-2">請聯繫賣家確認面交時間</p>
                </div>
              `,
              icon: 'success',
              confirmButtonText: '查看訂單',
              confirmButtonColor: '#6474E1'
            }).then((result) => {
              if (result.isConfirmed) {
                // 跳轉到訂單頁面
                window.location.href = '../elements/order.html';
              }
            });
          }
        });
      }

      // 購買後更新商品狀態
      async function updateItemStatusAfterPurchase(itemId) {
        try {
          const token = localStorage.getItem('token');
          
          // 更新商品狀態為 reserved
          const response = await fetch(`${API_BASE}/api/item/${itemId}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: 'reserved' })
          });
          
          if (response.ok) {
            console.log('商品狀態更新為 reserved');
            
            // 從收藏列表中移除已購買的商品
            const purchasedItem = document.querySelector(`[onclick*="toggleFavorite(${itemId}"]`);
            if (purchasedItem) {
              purchasedItem.closest('.col-span-12').remove();
            }
            
            // 更新本地列表
            favoriteItems = favoriteItems.filter(item => item.id !== itemId);
            
            // 檢查是否還有其他收藏商品
            if (favoriteItems.length === 0) {
              showEmptyState();
            }
          }
        } catch (error) {
          console.error('更新商品狀態失敗:', error);
        }
      }
      
      // HTML跳脫函數
      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }
      // 價格格式化函數
      function formatPrice(price) {
        return new Intl.NumberFormat('zh-TW', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(price);
      }

    </script>
  </body>
  <!-- [Body] end -->
</html>