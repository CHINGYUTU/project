<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <!-- [Head] start -->
  <head>
    <title>您的賣場</title>
    <!-- [Meta] -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="description"
      content="Datta Able is trending dashboard template made using Bootstrap 5 design framework. Datta Able is available in Bootstrap, React, CodeIgniter, Angular,  and .net Technologies."
    />
    <meta
      name="keywords"
      content="Bootstrap admin template, Dashboard UI Kit, Dashboard Template, Backend Panel, react dashboard, angular dashboard"
    />
    <meta name="author" content="CodedThemes" />

    <!-- [Favicon] icon -->
    <link rel="icon" href="../../assets/images/logo.png" type="image/x-icon" />

    <!-- [Font] Family -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <!-- [phosphor Icons] https://phosphoricons.com/ -->
    <link rel="stylesheet" href="../../assets/fonts/phosphor/duotone/style.css" />
    <!-- [Tabler Icons] https://tablericons.com -->
    <link rel="stylesheet" href="../../assets/fonts/tabler-icons.min.css" />
    <!-- [Feather Icons] https://feathericons.com -->
    <link rel="stylesheet" href="../../assets/fonts/feather.css" />
    <!-- [Font Awesome Icons] https://fontawesome.com/icons -->
    <link rel="stylesheet" href="../../assets/fonts/fontawesome.css" />
    <!-- [Material Icons] https://fonts.google.com/icons -->
    <link rel="stylesheet" href="../../assets/fonts/material.css" />
    <!-- [Template CSS Files] -->
    <link rel="stylesheet" href="../../assets/css/style.css" id="main-style-link" />
    <style>
      .password-checklist li {
        font-size: 15px;
        margin-bottom: 4px;
      }
      .progress {
        height: 8px;
        margin-top: 8px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
      }
      .progress-bar {
        transition: width 0.5s ease, background-color 0.4s ease;
        border-radius: 10px;
      }
      #strengthText {
        transition: color 0.4s ease;
      }
      /* 確保圖片容器保持正方形 */
      .avatar-container {
        width: 50px;
        height: 50px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        flex-shrink: 0;
      }
      /* 預覽大頭貼 */
      .avatar-preview-image {
        max-width: 100px;
        max-height: 100px;
        border: 1px dashed #ccc;
        margin-top: 5px;
      }
      /* 圖片樣式 */
      #avatar-display {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
        /* 添加状态标签样式 */
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }
      .status-available {
        background-color: #d1fae5;
        color: #065f46;
      }
      .status-rejected {
        background-color: #fee2e2;
        color: #b91c1c;
      }
      .status-sold {
        background-color: #e5e7eb;
        color: #374151;
      }
      /* 自定義按鈕樣式 */
      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background-color: #6474E1;
        color: white;
        border: 1px solid #6474E1;
      }
      .btn-primary:hover {
        background-color: #4f5bb5;
      }
      .btn-danger {
        background-color: #ef4444;
        color: white;
        border: 1px solid #ef4444;
      }
      .btn-danger:hover {
        background-color: #dc2626;
      }
      /* 加載動畫 */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <!-- [Head] end -->
  <!-- [Body] Start -->
  <body>
    <!-- [ Pre-loader ] start -->
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>
    <!-- [ Pre-loader ] End -->
    
    <!-- [ Sidebar Menu ] start -->
    <nav class="pc-sidebar">
      <div class="navbar-wrapper">
        <div class="m-header flex items-center py-4 px-6 h-header-height">
          <a class="b-brand flex items-center gap-3" href="../../../index.html">
            <img alt="Logo" class="logo" id="logo" src="../assets/images/logo.png" width="50">
            <p class="text-xl sm:text-3xl font-semibold text-slate-900 dark:text-white">二貨</p>
          </a>
        </div>

        <!-- 頭像顯示區域 -->
        <div class="m-header flex items-center py-4 px-6 h-header-height">
          <div class="avatar-container relative w-12 h-12 rounded-full overflow-hidden">
            <img id="avatar-display" 
                src="../assets/images/3.png"
                class="w-full h-full object-cover"
                onerror="this.src='../assets/images/3.png'">
            <div id="avatar-loader" class="hidden absolute inset-0 bg-gray-200 animate-pulse"></div>
          </div>
          <p class="text-base sm:text-xl font-medium text-slate-900 dark:text-white">您好</p>
        </div>
        
        <div class="navbar-content h-[calc(100vh_-_74px)] py-2.5">
          <ul class="pc-navbar">
            <li class="pc-item pc-caption">
              <label>賣家板</label>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/creat.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="plus-square"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">新增訂單</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/edit-order.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="list"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">訂單管理</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/conf.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="more-horizontal"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">待確認交易訂單</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/shop-trade.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="loader"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">待交易訂單</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/finish.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="check-circle"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">完成交易訂單</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="../../elements/seller/cancle.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon"> <i data-feather="x-circle"></i></span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">取消交易訂單</span>
              </a>
            </li>
            <li class="pc-item pc-caption">
              <label>其他</label>
              <i data-feather="sidebar"></i>
            </li>
            <li class="pc-item">
              <a href="../../../index.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon">
                  <i data-feather="home"></i>
                </span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">回首頁</span>
              </a>
            </li>
            <li class="pc-item">
              <a href="../../index.html" class="pc-link">
                <span style="color: rgba(100, 100, 159, 100);" class="pc-micon">
                  <i data-feather="log-out"></i>
                </span>
                <span style="color: rgba(100, 100, 159, 100);" class="pc-mtext">登出</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- [ Sidebar Menu ] end -->
    
    <!-- [ Header Topbar ] start -->
    <header class="pc-header">
      <div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow">
        <div class="me-auto pc-mob-drp">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="pc-h-item pc-sidebar-collapse max-lg:hidden lg:inline-flex">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="sidebar-hide">
                <i data-feather="menu"></i>
              </a>
            </li>
            <li class="pc-h-item pc-sidebar-popup lg:hidden">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="mobile-collapse">
                <i data-feather="menu"></i>
              </a>
            </li>
          </ul>
        </div>
        <div class="ms-auto">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button"
                aria-haspopup="false" aria-expanded="false">
                <i data-feather="sun"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item" onclick="layout_change('dark')">
                  <i data-feather="moon"></i>
                  <span>深色</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change('light')">
                  <i data-feather="sun"></i>
                  <span>明亮</span>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </header>
    <!-- [ Header ] end -->

    <!-- [ Main Content ] start -->
    <div class="pc-container">
      <div class="pc-content">
        <!-- [ breadcrumb ] start -->
        <div class="page-header">
          <div class="page-block">
            <div class="page-header-title">
              <h5 class="mb-0 font-medium">位置</h5>
            </div>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="../../../index.html">回首頁</a></li>
              <li class="breadcrumb-item"><a href="../../elements/profile.html">個人檔案</a></li>
              <li class="breadcrumb-item"><a href="../../elements/seller/shop.html">賣家專區</a></li>
              <li class="breadcrumb-item">訂單管理</li>
            </ul>
          </div>
        </div>
        <!-- [ breadcrumb ] end -->
        
        <div>
          <h3>訂單管理</h3>
          <div class="grid grid-cols-12 gap-4 mt-5" id="items-container">
            <!-- 商品卡片將在這裡動態生成 -->
          </div>
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>
    <!-- [ Main Content ] end -->
    
    <footer class="pc-footer">
    </footer>

    <!-- Required Js -->
    <script src="../../assets/js/plugins/simplebar.min.js"></script>
    <script src="../../assets/js/plugins/popper.min.js"></script>
    <script src="../../assets/js/icon/custom-icon.js"></script>
    <script src="../../assets/js/plugins/feather.min.js"></script>
    <script src="../../assets/js/component.js"></script>
    <script src="../../assets/js/theme.js"></script>
    <script src="../../assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
  // API 配置
  const API_CONFIG = {
    BASE_URL: 'http://localhost:3000',
    ENDPOINTS: {
      GET_MY_ITEMS: '/api/item/my-items',
      ITEM_DETAIL: '/api/item', // 基础路径，使用时添加ID
      ADD_ITEM: '/api/item/add'
    }
  };

  // 状态映射
  const STATUS_MAPPING = {
    'pending': { text: '審核中', class: 'status-pending' },
    'available': { text: '已上架', class: 'status-available' },
    'rejected': { text: '已拒絕', class: 'status-rejected' },
    'sold': { text: '已售出', class: 'status-sold' }
  };

  const CATEGORY_MAPPING = {
    1: '電子產品',
    2: '生活用品',
    3: '書籍',
    4: '運動用品',
    5: '服飾',
    6: '周邊'
  };

  // 顯示加載狀態
  function showLoading() {
    const container = document.getElementById("items-container");
    container.innerHTML = `
      <div class="col-span-12 text-center p-4">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-primary-500 rounded-full"></div>
        <p class="mt-2">載入中...</p>
      </div>
    `;
  }

  // 顯示錯誤訊息
  function showError(message) {
    const container = document.getElementById("items-container");
    container.innerHTML = `
      <div class="col-span-12 p-4 bg-red-50 border border-red-200 rounded">
        <h3 class="font-bold text-red-800">錯誤</h3>
        <p class="mt-2 text-red-700">${message}</p>
        <button onclick="loadMyItems()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          重新嘗試
        </button>
      </div>
    `;
  }

  // 圖片處理函數修改

  function getSafeImageUrl(url) {
    const defaultImage = '../assets/images/default-product.png';
    
    if (!url || url === 'NULL' || url === 'null' || url === 'default-product.png') {
      return defaultImage;
    }
    
    // 如果已经是完整URL则直接使用
    if (url.startsWith('http://') || url.startsWith('https://')) {
      return url;
    }
    
    // 确保BASE_URL不以斜线结尾
    const baseUrl = API_CONFIG.BASE_URL.endsWith('/') 
      ? API_CONFIG.BASE_URL.slice(0, -1) 
      : API_CONFIG.BASE_URL;
    
    return `${baseUrl}${url}`;
  }

    // 獲取當前用戶的商品
    async function loadMyItems() {
      showLoading();
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '../../index.html'; // 重定向到登录页
          return;
        }

        const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.GET_MY_ITEMS}`;
        console.log('请求 URL:', url);

        const res = await fetch(url, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (res.status === 401) {
          // token无效，重定向到登录
          localStorage.removeItem('token');
          window.location.href = '../../index.html';
          return;
        }

        if (!res.ok) {
          let errorMsg = `HTTP 错误! 状态码: ${res.status}`;
          try {
            const errorData = await res.json();
            errorMsg += `, 訊息: ${errorData.message || '無詳細訊息'}`;
          } catch (e) {
            errorMsg += ', 無法解析錯誤響應';
          }
          throw new Error(errorMsg);
        }

        const { data } = await res.json();
        displayItems(data);
        
      } catch (error) {
        console.error('載入失敗:', error);
        showError(`無法載入商品: ${error.message}`);
      }
    }

   // 在displayItems函數中保存商品數據
    function displayItems(items) {
      const container = document.getElementById("items-container");
      
      if (!items || items.length === 0) {
        container.innerHTML = `
          <div class="col-span-12 text-center p-4 bg-blue-50 border border-blue-200 rounded">
            目前沒有商品
          </div>
        `;
        return;
      }
      
      // 確保正確設置 data-item 屬性
      container.innerHTML = items.map(item => {
        const statusInfo = STATUS_MAPPING[item.status] || { text: '未知狀態', class: 'status-pending' };
        
        // 將商品數據轉為JSON字符串，確保特殊字符被正確處理
        const itemData = JSON.stringify(item).replace(/"/g, '&quot;');
        
        return `
        <div class="col-span-12 xl:col-span-4 md:col-span-6" 
            data-id="${item.id}" 
            data-item="${itemData}">
          <div class="card h-full flex flex-col">
            <img src="${getSafeImageUrl(item.image_url)}"
            onerror="this.onerror=null; this.src='../assets/images/default-product.png'"
            class="w-full h-48 object-cover" />
            <div class="card-header !pb-0 !border-b-0">
              <div class="flex justify-between items-start">
                <h4 class="text-lg font-semibold">${item.name || "未命名商品"}</h4>
                <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
              </div>
              ${item.description ? `<p class="text-gray-600 mt-1">${item.description}</p>` : ''}
            </div>
            <div class="card-body flex-grow">
              <div class="space-y-2">
                <p><span class="font-medium">價格:</span> $${item.price || "0"}</p>
                <p><span class="font-medium">分類:</span> ${CATEGORY_MAPPING[Number(item.category_id)] || "未知類別"}</p>
                <p><span class="font-medium">交易地點:</span> ${item.location || "未指定"}</p>
              </div>
            </div>
            <div class="card-footer p-4 border-t">
              <div class="flex gap-2 justify-end">
                ${item.status !== 'sold' ? `
                <button class="btn btn-primary btn-edit" data-id="${item.id}">
                  <i class="fas fa-edit mr-1"></i>修改
                </button>
                ` : ''}
                <button class="btn btn-danger btn-delete" data-id="${item.id}">
                  <i class="fas fa-trash-alt mr-1"></i>刪除
                </button>
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');
      
      // 重新綁定按鈕事件
      setTimeout(() => {
        document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditModal(btn.dataset.id);
          });
        });
        
        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteItem(btn.dataset.id);
          });
        });
      }, 100);
    }

    // 开启修改模态框 - 修正API路径
    async function openEditModal(itemId) {
      try {
        console.log('開始編輯商品:', itemId);
        
        // 先檢查商品元素是否存在
        const itemElement = document.querySelector(`[data-id="${itemId}"]`);
        if (!itemElement) {
          throw new Error('找不到商品資料，請刷新頁面後重試');
        }
        
        // 從data屬性獲取商品數據
        const itemData = itemElement.getAttribute('data-item');
        if (!itemData) {
          throw new Error('商品數據不完整，請刷新頁面後重試');
        }
        
        const item = JSON.parse(itemData);
        console.log('獲取到的商品數據:', item);

        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '../../index.html';
          return;
        }

        // 创建表单
        const formData = new FormData();
        let imageChanged = false;

        // 创建交互式表单
        const { value: formValues, isConfirmed } = await Swal.fire({
          title: '編輯商品',
          html: `
            <div class="text-left space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">商品名稱*</label>
                <input id="name" value="${item.name || ''}" class="swal2-input" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
                <textarea id="description" class="swal2-textarea">${item.description || ''}</textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">價格*</label>
                <input type="number" id="price" value="${item.price || ''}" class="swal2-input" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">分類*</label>
                <select id="category_id" class="swal2-select">
                  ${Object.entries(CATEGORY_MAPPING).map(([id, name]) => 
                    `<option value="${id}" ${id == item.category_id ? 'selected' : ''}>${name}</option>`
                  ).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">交易地點*</label>
                <input id="location" value="${item.location || ''}" class="swal2-input" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">商品圖片</label>
                <input type="file" id="image" accept="image/*" class="swal2-file">
                <small class="text-gray-500">不選擇檔案則保留原圖片</small>
                ${item.image_url ? `<div class="mt-2 text-sm text-gray-600">當前圖片: ${item.image_url}</div>` : ''}
              </div>
            </div>
          `,
          focusConfirm: false,
          showCancelButton: true,
          preConfirm: () => {
            const imageInput = document.getElementById('image');
            if (imageInput.files[0]) {
              formData.append('image', imageInput.files[0]);
              imageChanged = true;
            }
            
            formData.append('name', document.getElementById('name').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('category_id', document.getElementById('category_id').value);
            formData.append('location', document.getElementById('location').value);
            
            return formData;
          }
        });

        // 发送更新请求
        if (isConfirmed) {
          console.log('發送更新請求，商品ID:', itemId);
          
          // 構建正確的URL - 這是關鍵修正！
          const updateUrl = `${API_CONFIG.BASE_URL}/api/item/${itemId}`;
          console.log('更新請求URL:', updateUrl);
          
          const patchRes = await fetch(updateUrl, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
            },
            body: formData
          });

          console.log('更新回應狀態:', patchRes.status);
          
          if (patchRes.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '../../index.html';
            return;
          }

          if (!patchRes.ok) {
            let errorData;
            try {
              errorData = await patchRes.json();
            } catch (e) {
              errorData = { message: '無法解析錯誤回應' };
            }
            console.error('更新錯誤詳細信息:', errorData);
            throw new Error(errorData.message || `更新失敗: ${patchRes.status}`);
          }

          const result = await patchRes.json();
          console.log('更新成功:', result);
          
          Swal.fire('成功', '商品已更新，待管理員重新審核', 'success');
          loadMyItems(); // 刷新列表
        }
      } catch (error) {
        console.error('編輯商品錯誤詳細信息:', error);
        Swal.fire('錯誤', `編輯失敗: ${error.message}`, 'error');
      }
    }
      // 全局錯誤處理
      window.addEventListener('error', function(event) {
        console.error('全局錯誤:', event.error);
        // 可以顯示友好的錯誤訊息
        const container = document.getElementById("items-container");
        if (container) {
          container.innerHTML = `
            <div class="col-span-12 p-4 bg-red-50 border border-red-200 rounded">
              <h3 class="font-bold text-red-800">頁面加載錯誤</h3>
              <p class="mt-2 text-red-700">請刷新頁面或聯繫管理員</p>
              <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                刷新頁面
              </button>
            </div>
          `;
        }
      });

      // 頁面加載完成後初始化
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            window.location.href = '../../index.html';
            return;
          }
          
          console.log('頁面開始加載...');
          loadMyItems();
          
          if (typeof feather !== 'undefined') {
            feather.replace();
          }
        } catch (error) {
          console.error('頁面初始化錯誤:', error);
        }
      });
    </script>
    
    <script>
      // ======================= 頭像獲取與顯示 =======================
      const API_BASE = 'http://localhost:3000'; // 添加API_BASE定義
      
      document.addEventListener("DOMContentLoaded", async function() {
          const avatarElement = document.getElementById("avatar-display");
          const defaultAvatar = "../assets/images/3.png"; // 預設頭像路徑
          
          try {
              // 1. 先檢查本地緩存
              const cachedAvatar = localStorage.getItem("userAvatar");
              if (cachedAvatar) {
                  avatarElement.src = cachedAvatar;
                  return; // 如果有緩存就直接使用
              }
              
              // 2. 從API獲取用戶資料（包含頭像資訊）
              const response = await fetch(`${API_BASE}/api/user/profile`, {
                  headers: {
                      'Authorization': `Bearer ${localStorage.getItem("token")}`
                  }
              });
              
              if (response.ok) {
                  const data = await response.json();
                  // 根據您的後端回應結構調整這裡
                  if (data.avatarUrl || data.avatar) {
                      // 添加時間戳避免緩存問題
                      const avatarUrl = `${API_BASE}${data.avatarUrl || data.avatar}?t=${new Date().getTime()}`;
                      avatarElement.src = avatarUrl;
                      localStorage.setItem("userAvatar", avatarUrl); // 緩存到本地
                  } else {
                      // 如果沒有頭像，使用預設頭像
                      avatarElement.src = defaultAvatar;
                  }
              } else {
                  throw new Error("獲取用戶資料失敗");
              }
          } catch (error) {
              console.error("頭像加載錯誤:", error);
              avatarElement.src = defaultAvatar; // 失敗時使用預設頭像
          }
      });
    </script>
  </body>
  <!-- [Body] end -->
</html>